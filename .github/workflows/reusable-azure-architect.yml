name: Azure Architect Stage

on:
  workflow_call:
    inputs:
      dotnet-version:
        required: false
        type: string
        default: '8.0.x'

jobs:
  azure-architect:
    name: Architecture Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate repository structure
        run: |
          echo "ðŸ—ï¸ Azure Architect: Validating architecture..."
          echo "================================================"
          
          # Check for architecture documentation
          if [ -d "docs" ]; then
            echo "âœ… Documentation directory exists"
          else
            echo "âš ï¸ No docs directory found"
          fi
          
          # Check for fabric manifest
          if [ -d "fabric-manifest" ]; then
            echo "âœ… Fabric manifest directory exists"
            if [ -f "fabric-manifest/workload-manifest.json" ]; then
              echo "âœ… Workload manifest found"
            else
              echo "âŒ Missing workload-manifest.json"
              exit 1
            fi
          else
            echo "âš ï¸ No fabric-manifest directory (not required for all projects)"
          fi
          
          # Check for solution structure
          if ls *.sln 1> /dev/null 2>&1; then
            echo "âœ… Solution file(s) found"
          else
            echo "âŒ No solution file found"
            exit 1
          fi
          
          echo ""
          echo "Architecture validation completed"

      - name: Validate Fabric manifest structure
        if: hashFiles('fabric-manifest/workload-manifest.json') != ''
        run: |
          echo "ðŸ” Validating Fabric manifest structure..."
          
          # Check if manifest is valid JSON
          if jq empty fabric-manifest/workload-manifest.json 2>/dev/null; then
            echo "âœ… workload-manifest.json is valid JSON"
          else
            echo "âŒ workload-manifest.json is not valid JSON"
            exit 1
          fi
          
          # Check for required manifest sections
          if jq -e '.workload' fabric-manifest/workload-manifest.json > /dev/null 2>&1; then
            echo "âœ… Workload section exists"
          else
            echo "âš ï¸ No workload section in manifest"
          fi

      - name: Validate project structure conventions
        run: |
          echo "ðŸ“ Validating project structure..."
          
          # Check for src directory
          if [ -d "src" ]; then
            echo "âœ… src/ directory exists"
          else
            echo "âŒ No src/ directory found"
            exit 1
          fi
          
          # Check for tests directory
          if [ -d "tests" ]; then
            echo "âœ… tests/ directory exists"
          else
            echo "âš ï¸ No tests/ directory found (recommended)"
          fi
          
          # Check for scripts directory
          if [ -d "scripts" ]; then
            echo "âœ… scripts/ directory exists"
          else
            echo "âš ï¸ No scripts/ directory found (optional)"
          fi

      - name: Generate architecture report
        run: |
          echo "ðŸ“Š Architecture Report" >> $GITHUB_STEP_SUMMARY
          echo "=====================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Project Structure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Solutions**: $(find . -name '*.sln' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Projects**: $(find . -name '*.csproj' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Projects**: $(find . -name '*.Tests.csproj' -o -name '*.IntegrationTests.csproj' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "docs" ]; then
            echo "- Documentation files: $(find docs -name '*.md' | wc -l)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- No docs directory" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Architecture validation passed" >> $GITHUB_STEP_SUMMARY
