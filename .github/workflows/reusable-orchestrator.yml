name: Orchestrator Stage

on:
  workflow_call:
    inputs:
      dotnet-version:
        required: false
        type: string
        default: '8.0.x'

jobs:
  orchestrator:
    name: Final Orchestration and Summary
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Analyze artifacts
        id: analyze
        run: |
          echo "ðŸ“¦ Analyzing collected artifacts..."
          
          if [ -d "./artifacts" ]; then
            echo "Artifacts found:"
            find ./artifacts -type f | head -20
            
            artifact_count=$(find ./artifacts -type d -mindepth 1 -maxdepth 1 | wc -l)
            echo "artifact_count=$artifact_count" >> $GITHUB_OUTPUT
          else
            echo "No artifacts downloaded"
            echo "artifact_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Verify build artifacts
        run: |
          echo "ðŸ” Verifying build artifacts..."
          
          if [ -d "./artifacts/build-output" ]; then
            echo "âœ… Build artifacts present"
            find ./artifacts/build-output -name '*.dll' | head -10
          else
            echo "âš ï¸ No build artifacts found"
          fi

      - name: Verify deployment package
        run: |
          echo "ðŸ” Verifying deployment package..."
          
          if [ -d "./artifacts/deployment-package" ]; then
            echo "âœ… Deployment package present"
            ls -lah ./artifacts/deployment-package
          else
            echo "âš ï¸ No deployment package found"
          fi

      - name: Verify frontend build
        run: |
          echo "ðŸ” Verifying frontend build..."
          
          if [ -d "./artifacts/frontend-build" ]; then
            echo "âœ… Frontend build present"
            ls -lah ./artifacts/frontend-build
          else
            echo "âš ï¸ No frontend build found"
          fi

      - name: Verify test results
        run: |
          echo "ðŸ” Verifying test results..."
          
          # Check unit tests
          if [ -d "./artifacts/unit-test-results" ]; then
            echo "âœ… Unit test results present"
            find ./artifacts/unit-test-results -name '*.trx' | wc -l
          else
            echo "âš ï¸ No unit test results found"
          fi
          
          # Check integration tests
          if [ -d "./artifacts/integration-test-results" ]; then
            echo "âœ… Integration test results present"
          else
            echo "âš ï¸ No integration test results found (may be expected)"
          fi

      - name: Verify coverage report
        run: |
          echo "ðŸ” Verifying coverage report..."
          
          if [ -d "./artifacts/coverage-report" ]; then
            echo "âœ… Coverage report present"
            
            # Display coverage summary if available
            if [ -f "./artifacts/coverage-report/Summary.txt" ]; then
              echo "Coverage Summary:"
              cat ./artifacts/coverage-report/Summary.txt
            fi
          else
            echo "âš ï¸ No coverage report found"
          fi

      - name: Aggregate pipeline metrics
        id: metrics
        run: |
          echo "ðŸ“Š Aggregating pipeline metrics..."
          
          # Count projects
          project_count=$(find . -name '*.csproj' | wc -l)
          echo "project_count=$project_count" >> $GITHUB_OUTPUT
          
          # Count test projects
          test_project_count=$(find . -name '*.Tests.csproj' -o -name '*.IntegrationTests.csproj' | wc -l)
          echo "test_project_count=$test_project_count" >> $GITHUB_OUTPUT
          
          # Check documentation
          doc_count=$(find docs -name '*.md' 2>/dev/null | wc -l)
          echo "doc_count=$doc_count" >> $GITHUB_OUTPUT
          
          echo "Metrics:"
          echo "  - Projects: $project_count"
          echo "  - Test Projects: $test_project_count"
          echo "  - Documentation Files: $doc_count"

      - name: Verify merge readiness
        run: |
          echo "âœ… Merge Readiness Checklist"
          echo "============================"
          echo ""
          
          checks_passed=0
          checks_total=7
          
          # Check 1: Architecture validation
          echo "âœ… 1. Architecture validation passed"
          ((checks_passed++))
          
          # Check 2: Build succeeded
          if [ -d "./artifacts/build-output" ]; then
            echo "âœ… 2. Build artifacts generated"
            ((checks_passed++))
          else
            echo "âŒ 2. Build artifacts missing"
          fi
          
          # Check 3: CI/CD configuration
          if [ -d ".github/workflows" ]; then
            echo "âœ… 3. CI/CD configuration validated"
            ((checks_passed++))
          else
            echo "âŒ 3. CI/CD configuration incomplete"
          fi
          
          # Check 4: Frontend validation
          if [ -d "./artifacts/frontend-build" ] || [ ! -d "src/FabricMappingService.Frontend" ]; then
            echo "âœ… 4. Frontend validation passed"
            ((checks_passed++))
          else
            echo "âš ï¸ 4. Frontend validation incomplete (non-blocking)"
            ((checks_passed++))
          fi
          
          # Check 5: Integration tests
          if [ -d "./artifacts/integration-test-results" ] || [ "$(find . -name '*.IntegrationTests.csproj' | wc -l)" -eq "0" ]; then
            echo "âœ… 5. Integration tests passed or not required"
            ((checks_passed++))
          else
            echo "âš ï¸ 5. Integration tests not run (non-blocking)"
            ((checks_passed++))
          fi
          
          # Check 6: Unit tests
          if [ -d "./artifacts/unit-test-results" ]; then
            echo "âœ… 6. Unit tests executed with coverage"
            ((checks_passed++))
          else
            echo "âŒ 6. Unit test results missing"
          fi
          
          # Check 7: Deployment package
          if [ -d "./artifacts/deployment-package" ]; then
            echo "âœ… 7. Deployment package created"
            ((checks_passed++))
          else
            echo "âŒ 7. Deployment package missing"
          fi
          
          echo ""
          echo "Status: $checks_passed/$checks_total checks passed"
          
          if [ $checks_passed -ge 6 ]; then
            echo "âœ… Pipeline is ready for merge"
          else
            echo "âš ï¸ Some checks failed - review required"
          fi

      - name: Generate final orchestrator report
        run: |
          echo "# ðŸŽ¯ Sequential Multi-Agent Workflow - Final Report" >> $GITHUB_STEP_SUMMARY
          echo "=================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All stages have completed successfully in sequential order:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… **Azure Architect** - Architecture validation" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… **.NET Senior Developer** - Build and code analysis" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… **DevOps Engineer** - CI/CD and artifact creation" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… **Blazor Fluent UI Specialist** - Frontend validation" >> $GITHUB_STEP_SUMMARY
          echo "5. âœ… **Test Specialist** - Integration/E2E tests" >> $GITHUB_STEP_SUMMARY
          echo "6. âœ… **Unit Test Specialist** - Unit tests with coverage" >> $GITHUB_STEP_SUMMARY
          echo "7. âœ… **Orchestrator** - Final coordination and verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Project Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Total Projects: ${{ steps.metrics.outputs.project_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Projects: ${{ steps.metrics.outputs.test_project_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation Files: ${{ steps.metrics.outputs.doc_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts Collected: ${{ steps.analyze.outputs.artifact_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts Available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following artifacts are available for download:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "./artifacts/build-output" ]; then
            echo "- ðŸ“¦ **build-output** - Compiled binaries" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "./artifacts/deployment-package" ]; then
            echo "- ðŸš€ **deployment-package** - Ready-to-deploy package (30 days retention)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "./artifacts/frontend-build" ]; then
            echo "- ðŸŽ¨ **frontend-build** - Built frontend assets" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "./artifacts/unit-test-results" ]; then
            echo "- ðŸ§ª **unit-test-results** - Unit test execution results" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "./artifacts/coverage-report" ]; then
            echo "- ðŸ“Š **coverage-report** - Code coverage analysis (30 days retention)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "./artifacts/integration-test-results" ]; then
            echo "- ðŸ”— **integration-test-results** - Integration test results" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review all stage reports above" >> $GITHUB_STEP_SUMMARY
          echo "2. Download and inspect artifacts as needed" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify code coverage meets project standards" >> $GITHUB_STEP_SUMMARY
          echo "4. If all checks pass, this PR is ready for human review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **All sequential agent stages completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For workflow documentation, see: \`docs/sequential-handoff-workflow.md\`" >> $GITHUB_STEP_SUMMARY
